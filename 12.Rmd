---
title: "Otros análisis"
output: 
  html_document: 
    theme: flatly
    number_sections: yes
    df_print: kable
editor_options: 
  chunk_output_type: console
---

### OTROS ANÁLISIS

En la búsqueda de patrones, creemos oportuno probar la existencia de grupos diferenciados a partir de los indicadores básicos trabajados.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
suppressMessages(library(expss))
suppressMessages(library(DT))
suppressMessages(library(NbClust))

data01 <- subset(data, select = c(REGISTRO, P1,P2,P4, P5B, P17_1,P17_4,P17_5,P17_6,P17_7,P17_8))
mh <- round(mahalanobis(data01[,-1], colMeans(data01[,-1]), cov(data01[,-1])),5)
pmh <- round(pchisq(mh, df=10, lower.tail=FALSE),5)
data01 <- cbind(data01, mh,pmh)
data02 <- subset(data01, pmh > 0.001)
data03 <- subset(data01, pmh <= 0.001)
data01 <- data02[,c(-12,-13)]
```

Se ha/n eliminado `r nrow(data03)` outlier/s. Se muestran su datos más significativos.

`r datatable(data03[,c(1,12,13)])`

### Conocer nº óptimo de grupos

Realizamos el análisis y listamos sus resultados. Nótese en la agenda de casos, que un número negativo significa referencia al caso original, mientras que un número positivo indica una referencia un grupo creado en el paso indicado por el número

```{r fig.width=16, fig.height=9}
#calculo las distancias (package stats)
dist01 <- dist(data01[,-1])
#calculo clusters
clusters <- hclust(dist01, method = "ward.D")
res.wardD2<-NbClust(data01, distance = "euclidean", min.nc = 2, max.nc = 5, method = "ward.D", index = "alllong")
#res.wardD2$All.index
#res.wardD2$Best.nc
#res.wardD2$Best.partition
```

# Clúster K-medias

### Cálculo - Solución 2 grupos


Hacemos el análisis K-means para 2 grupos.

```{r}
grupos=2
#cluster kmeans
set.seed(311265)
kclusterCut <- kmeans(data01[,-1], grupos, nstart = 10)
```
#### Tamaño de los grupos

`r kclusterCut[["size"]]`

#### Centros finales de los grupos

`r as.datatable_widget(kclusterCut[["centers"]])`

### Creación de las variables de grupo

```{r}
grps <- kclusterCut[["cluster"]]
```

Procedemos a unir las variables de pertenencia del K-means con el fichero original.

```{r}
data03 <- cbind(data01[,1], grps)
datafinal <- merge(data, data03, by = "REGISTRO")
```

### Caracterización de grupos, contraste t medias en muestra independientes

```{r}
datafinal = apply_labels(datafinal, grps = "Grupo" )
as.datatable_widget(datafinal %>% 
    tab_cells(P1,P2,P4, P5B, P17_1,P17_4,P17_5,P17_6,P17_7,P17_8) %>% 
    tab_cols(grps) %>% 
    tab_stat_mean_sd_n() %>% 
    tab_last_sig_means() %>% 
    tab_pivot()) 
  
```

### Perfil de los grupos, contrastes inferenciales

Perfilamos los grupos con otros datos del banco de datos. Hacemos la prueba Chisq para los datos nominales y la prueba T para los métricos.

```{r }
as.datatable_widget(datafinal %>% 
    tab_cells(R1C) %>% 
    tab_cols(grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cases() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R1D) %>% 
    tab_cols(grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cases() %>% 
    tab_pivot()) 

as.datatable_widget(datafinal %>% 
    tab_cells(R2) %>% 
    tab_cols(grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cases() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R3REC) %>% 
    tab_cols(grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cases() %>% 
    tab_pivot())
```

### Perfil de los grupos, contrastes inferenciales chisq de celda

Perfilamos los grupos con otros datos del banco de datos. Hacemos la prueba Chisq de celda para ver direcciones de dependencia en celdas significativas.

```{r }
as.datatable_widget(datafinal %>% 
    tab_cells(R1C) %>% 
    tab_cols(total(),grps) %>% 
    tab_stat_cpct() %>% 
    tab_last_sig_cell_chisq() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R1D) %>% 
    tab_cols(total(),grps) %>% 
    tab_stat_cpct() %>% 
    tab_last_sig_cell_chisq() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R2) %>% 
    tab_cols(total(),grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cell_chisq() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R3REC) %>% 
    tab_cols(total(),grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cell_chisq() %>% 
    tab_pivot()) 
  
```


```{r echo=FALSE}
library(factoextra)
fviz_nbclust(data01, kmeans, method = "wss") +
geom_vline(xintercept = 2, linetype = 2)
```
```{r}
set.seed(311265)
km.res <- kmeans(data01[,-1], 2, nstart = 25)
km.res
fviz_cluster(km.res, data = data01[,-1],
    palette = c("#2E9FDF", "#00AFBB", "#E7B800", "#FC4E07"),
    ellipse.type = "euclid", # Concentration ellipse
    star.plot = TRUE, # Add segments from centroids to items
    repel = TRUE) # Avoid label overplotting (slow)
```


# Clúster K-medias

### Cálculo - Solución 4 grupos


Hacemos el análisis K-means para4 grupos.

```{r}
grupos=4
#cluster kmeans
set.seed(311265)
kclusterCut <- kmeans(data01[,-1], grupos, nstart = 10)
```

#### Tamaño de los grupos

`r kclusterCut[["size"]]`

#### Centros finales de los grupos

`r as.datatable_widget(kclusterCut[["centers"]])`

### Creación de las variables de grupo

```{r}
grps <- kclusterCut[["cluster"]]
```

Procedemos a unir las variables de pertenencia del K-means con el fichero original.

```{r}
data03 <- cbind(data01[,1], grps)
datafinal <- merge(data, data03, by = "REGISTRO")
```

### Caracterización de grupos, contraste t medias en muestra independientes

```{r}
datafinal = apply_labels(datafinal, grps = "Grupo" )
as.datatable_widget(datafinal %>% 
    tab_cells(P1,P2,P4, P5B, P17_1,P17_4,P17_5,P17_6,P17_7,P17_8) %>% 
    tab_cols(grps) %>% 
    tab_stat_mean_sd_n() %>% 
    tab_last_sig_means() %>% 
    tab_pivot()) 
  
```

### Perfil de los grupos, contrastes inferenciales

Perfilamos los grupos con otros datos del banco de datos. Hacemos la prueba Chisq para los datos nominales y la prueba T para los métricos.

```{r }
as.datatable_widget(datafinal %>% 
    tab_cells(R1C) %>% 
    tab_cols(grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cases() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R1D) %>% 
    tab_cols(grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cases() %>% 
    tab_pivot()) 

as.datatable_widget(datafinal %>% 
    tab_cells(R2) %>% 
    tab_cols(grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cases() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R3REC) %>% 
    tab_cols(grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cases() %>% 
    tab_pivot())
```

### Perfil de los grupos, contrastes inferenciales chisq de celda

Perfilamos los grupos con otros datos del banco de datos. Hacemos la prueba Chisq de celda para ver direcciones de dependencia en celdas significativas.

```{r }
as.datatable_widget(datafinal %>% 
    tab_cells(R1C) %>% 
    tab_cols(total(),grps) %>% 
    tab_stat_cpct() %>% 
    tab_last_sig_cell_chisq() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R1D) %>% 
    tab_cols(total(),grps) %>% 
    tab_stat_cpct() %>% 
    tab_last_sig_cell_chisq() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R2) %>% 
    tab_cols(total(),grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cell_chisq() %>% 
    tab_pivot()) 
  
as.datatable_widget(datafinal %>% 
    tab_cells(R3REC) %>% 
    tab_cols(total(),grps) %>% 
    tab_stat_cases() %>% 
    tab_last_sig_cell_chisq() %>% 
    tab_pivot()) 
  
```

```{r echo=FALSE}
library(factoextra)
fviz_nbclust(data01, kmeans, method = "wss") +
geom_vline(xintercept = 4, linetype = 2)
```
```{r}
set.seed(311265)
km.res <- kmeans(data01[,-1], 4, nstart = 25)
km.res
fviz_cluster(km.res, data = data01[,-1],
    palette = c("#2E9FDF", "#00AFBB", "#E7B800", "#FC4E07"),
    ellipse.type = "euclid", # Concentration ellipse
    star.plot = TRUE, # Add segments from centroids to items
    repel = TRUE) # Avoid label overplotting (slow)
```

